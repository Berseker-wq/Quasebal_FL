{% extends 'base.html.twig' %}

{% block title %}Paiement CB{% endblock %}

{% block body %}
<h2>Paiement par Carte Bancaire</h2>

<form id="payment-form" action="{{ path('app_paiement_cb_api') }}" method="POST">
    <div id="card-element"><!-- Stripe Card Element --></div>
    <div id="card-errors" class="text-danger mt-2"></div>
    

    <button id="submit-button" class="btn btn-primary mt-3">
        <span id="submit-text">Payer {{ total }} €</span>
        <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
    </button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');
    const spinner = document.getElementById('spinner');
    const submitText = document.getElementById('submit-text');
    const cardErrors = document.getElementById('card-errors');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitButton.disabled = true;
        spinner.classList.remove('d-none');
        submitText.textContent = 'Paiement en cours...';
        cardErrors.textContent = '';

        try {
            const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: card,
            });

            if (error) throw error;

            const response = await fetch(form.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentMethodId: paymentMethod.id }),
            });

            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Erreur serveur : réponse inattendue");
            }

            const result = await response.json();

            if (result.error) throw new Error(result.error);

            if (result.requiresAction) {
                const confirmation = await stripe.confirmCardPayment(result.paymentIntentClientSecret);
                if (confirmation.error) throw confirmation.error;

                window.location.href = result.redirect ?? '/commande/confirmation';
            } else if (result.success) {
                window.location.href = result.redirect;
            } else {
                throw new Error("Paiement non réussi.");
            }

        } catch (err) {
            cardErrors.textContent = err.message;
            spinner.classList.add('d-none');
            submitText.textContent = 'Payer {{ total }} €';
            submitButton.disabled = false;
        }
    });
</script>
{% endblock %}
