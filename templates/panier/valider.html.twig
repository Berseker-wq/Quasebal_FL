{% extends 'base.html.twig' %}

{% block title %}Validation du panier{% endblock %}

{% block stylesheets %}
    <style>
        /* ici tu peux coller le CSS au-dessus si tu ne veux pas toucher à base.html.twig */
    </style>
{% endblock %}

{% block body %}
<div class="form-container">
    <h1>Validation de votre panier</h1>

    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    {% if produitsPanier is empty %}
        <p>Votre panier est vide.</p>
        <a href="{{ path('app_catalogue_plats') }}" class="btn btn-primary">Retour aux plats</a>
    {% else %}
        <form method="post" action="{{ path('app_commande') }}">
            <input type="hidden" name="_token" value="{{ csrf_token('valider_commande') }}">
            <h3>Adresse de livraison</h3>
            <div class="mb-3">
                <label for="nom">Nom</label>
                <input type="text" class="form-control" name="nom" id="nom" required>
            </div>
            <div class="mb-3">
                <label for="adresse">Adresse</label>
                <input type="text" class="form-control" name="adresse" id="adresse" required>
            </div>
            <div class="mb-3">
                <label for="rue">Rue</label>
                <input type="text" class="form-control" name="rue" id="rue" required>
            </div>
            <div class="mb-3">
                <label for="codePostal">Code Postal</label>
                <input type="text" class="form-control" name="codePostal" id="codePostal" required>
            </div>
            <div class="mb-3">
                <label for="email">Email</label>
                <input type="email" class="form-control" name="email" id="email" required>
            </div>
            <div class="mb-3">
                <label for="telephone">Téléphone</label>
                <input type="tel" class="form-control" name="telephone" id="telephone" required>
            </div>
            <h3>Adresse de facturation</h3>
            <div class="mb-3">
                <label for="nomFacturation">Nom</label>
                <input type="text" class="form-control" name="nomFacturation" id="nomFacturation" required>
            </div>
            <div class="mb-3">
                <label for="adresseFacturation">Adresse</label>
                <input type="text" class="form-control" name="adresseFacturation" id="adresseFacturation" required>
            </div>
            <div class="mb-3">
                <label for="rueFacturation">Rue</label>
                <input type="text" class="form-control" name="rueFacturation" id="rueFacturation" required>
            </div>
            <div class="mb-3">
                <label for="codePostalFacturation">Code Postal</label>
                <input type="text" class="form-control" name="codePostalFacturation" id="codePostalFacturation" required>
            </div>
            <div class="mb-3">
                <h3>Mode de paiement</h3>
                {% for mode, label in {
                    'CB': 'Carte Bancaire',
                    'PayPal': 'PayPal',
                    'Payement en Nature': 'Payement en Nature',
                    'Pas dargent': 'Pas dargent'
                } %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modePaiement" id="paiement{{ mode }}" value="{{ mode }}" {% if loop.first %}checked{% endif %}>
                        <label class="form-check-label" for="paiement{{ mode }}">{{ label }}</label>
                    </div>
                {% endfor %}
            </div>

            <h4>Résumé du panier :</h4>
            <ul>
                {% for produit in produitsPanier %}
                    <li>{{ produit.nom }} x {{ produit.quantite }} – {{ produit.totalProduit|number_format(2, '.', ',') }} €</li>
                {% endfor %}
            </ul>

            {# Bloc résumé des prix #}
            <h4>Résumé des prix :</h4>
            <p>Sous-total : <strong>{{ total|number_format(2, ',', ' ') }} €</strong></p>

            {% if reduction is defined and reduction > 0 %}
                <p>Réduction : <strong>-{{ reduction|number_format(2, ',', ' ') }} €</strong></p>
                <h3>Total à payer : <strong>{{ totalAvecReduction|number_format(2, ',', ' ') }} €</strong></h3>
            {% else %}
                <h3>Total à payer : <strong>{{ total|number_format(2, ',', ' ') }} €</strong></h3>
            {% endif %}

            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" name="accepter_cgu" id="accepter_cgu" required>
                <label class="form-check-label" for="accepter_cgu">
                    J'accepte les <a href="{{ path('app_panier') }}" target="_blank">Conditions Générales d'Utilisation</a>.
                </label>
            </div>

            <button type="submit" class="btn btn-success mt-3">✅ Confirmer ma commande</button>
        </form>

        <a href="{{ path('app_panier') }}" class="btn btn-secondary mt-3">⬅️ Retour au panier</a>
    {% endif %}
</div>
{% endblock %}
